<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>训练指令 | ljh blog</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/github-markdown-css/2.2.1/github-markdown.css">
    <meta name="description" content="welcomg to my blog">
    
    <link rel="preload" href="/myblog/assets/css/0.styles.2751e863.css" as="style"><link rel="preload" href="/myblog/assets/js/app.f3a8c44d.js" as="script"><link rel="preload" href="/myblog/assets/js/2.deb0a2cd.js" as="script"><link rel="preload" href="/myblog/assets/js/1.1c52931d.js" as="script"><link rel="preload" href="/myblog/assets/js/25.d83bf4c1.js" as="script"><link rel="prefetch" href="/myblog/assets/js/10.694d5f81.js"><link rel="prefetch" href="/myblog/assets/js/11.3bd8c434.js"><link rel="prefetch" href="/myblog/assets/js/12.17a49a12.js"><link rel="prefetch" href="/myblog/assets/js/13.5ae52801.js"><link rel="prefetch" href="/myblog/assets/js/14.8c09c612.js"><link rel="prefetch" href="/myblog/assets/js/15.b5c664e2.js"><link rel="prefetch" href="/myblog/assets/js/16.f098661e.js"><link rel="prefetch" href="/myblog/assets/js/17.317320b8.js"><link rel="prefetch" href="/myblog/assets/js/18.17a1ac99.js"><link rel="prefetch" href="/myblog/assets/js/19.5ebe14ee.js"><link rel="prefetch" href="/myblog/assets/js/20.c594918f.js"><link rel="prefetch" href="/myblog/assets/js/21.3cb50dce.js"><link rel="prefetch" href="/myblog/assets/js/22.d609495a.js"><link rel="prefetch" href="/myblog/assets/js/23.b052faad.js"><link rel="prefetch" href="/myblog/assets/js/24.c19ff3c2.js"><link rel="prefetch" href="/myblog/assets/js/26.31fec3f6.js"><link rel="prefetch" href="/myblog/assets/js/27.e0743bf6.js"><link rel="prefetch" href="/myblog/assets/js/28.a29e5507.js"><link rel="prefetch" href="/myblog/assets/js/29.f346562f.js"><link rel="prefetch" href="/myblog/assets/js/3.1dc19e39.js"><link rel="prefetch" href="/myblog/assets/js/30.9cb32433.js"><link rel="prefetch" href="/myblog/assets/js/31.12ec5f93.js"><link rel="prefetch" href="/myblog/assets/js/32.0d34c9b6.js"><link rel="prefetch" href="/myblog/assets/js/33.267ef253.js"><link rel="prefetch" href="/myblog/assets/js/34.24cdb3ad.js"><link rel="prefetch" href="/myblog/assets/js/35.bce3203c.js"><link rel="prefetch" href="/myblog/assets/js/36.7fc4efa7.js"><link rel="prefetch" href="/myblog/assets/js/37.6e4d1671.js"><link rel="prefetch" href="/myblog/assets/js/38.f305a7f7.js"><link rel="prefetch" href="/myblog/assets/js/39.66322564.js"><link rel="prefetch" href="/myblog/assets/js/4.b75b3758.js"><link rel="prefetch" href="/myblog/assets/js/40.64d0cf10.js"><link rel="prefetch" href="/myblog/assets/js/41.983332ee.js"><link rel="prefetch" href="/myblog/assets/js/5.1e62db32.js"><link rel="prefetch" href="/myblog/assets/js/6.7bce7aa0.js"><link rel="prefetch" href="/myblog/assets/js/7.86ec2833.js"><link rel="prefetch" href="/myblog/assets/js/vendors~docsearch.81710675.js">
    <link rel="stylesheet" href="/myblog/assets/css/0.styles.2751e863.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/myblog/" class="home-link router-link-active"><!----> <span class="site-name">ljh blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/myblog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/myblog/about/about.html" class="nav-link">
  about
</a></div><div class="nav-item"><a href="https://github.com/ChosenOne23" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/myblog/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/myblog/about/about.html" class="nav-link">
  about
</a></div><div class="nav-item"><a href="https://github.com/ChosenOne23" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/myblog/tec/" class="sidebar-heading clickable"><span>技术</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/myblog/exp/" class="sidebar-heading clickable router-link-active open"><span>实验</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/myblog/exp/training_order.html" aria-current="page" class="active sidebar-link">训练指令</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/myblog/exp/idea.html" class="sidebar-link">想法</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/myblog/paper/" class="sidebar-heading clickable"><span>论文</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/myblog/prepare4work/pre4work.html" class="sidebar-link">prepare4work</a></li><li><a href="/myblog/reading/insights.html" class="sidebar-link">阅读</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="训练指令"><a href="#训练指令" class="header-anchor">#</a> 训练指令</h3> <p>train.sh 文件下修改运行train.py的参数，如--nothing,--dataset,--fusion_mode</p> <p>tee：保存命令行的输出结果，结果保存在./trainlog_mosei/mylog.log路径下，-a代表以追加的形式</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">bash</span> train_origin.sh <span class="token parameter variable">--nothing</span> <span class="token parameter variable">--dataset</span> mosei <span class="token parameter variable">--fusion_mode</span> inter_intra <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> ./trainlog_mosei/mylog.log
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">bash</span> train_tcp.sh <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> ./trainlog_mosei/mylog_tcp.log
</code></pre></div><p>消融实验</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">bash</span> train_origin.sh <span class="token parameter variable">--nothing</span> <span class="token parameter variable">--dataset</span> mosei <span class="token parameter variable">--fusion_mode</span> inter_intra <span class="token parameter variable">--without_modality</span> t <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> ./trainlog_mosei/mylog_wt.log
</code></pre></div><h3 id="可视化指令"><a href="#可视化指令" class="header-anchor">#</a> 可视化指令</h3> <p><strong>visualize.sh</strong>文件下，可视化注意力机制的结果，通过运行<strong>visualize.py</strong>文件，可指定参数 <strong>--visualize 样本名</strong>，得到对应样本的attention_weight，为一字典类型，包含global（fusion_mode为global时）; inter，intra（fusion_mode为inter_intra时）模型的注意力结果，shape为(layers, bsz, num_heads, q_len, kv_len)</p> <p>总共涉及到2个文件：visualize.py，model_attenvisualize.py</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">bash</span> visualize.sh <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> ./visualizelog_mosei/mylog.log
</code></pre></div><h3 id="对齐操作"><a href="#对齐操作" class="header-anchor">#</a> 对齐操作</h3> <ol><li><p>首先，使用<strong>d\数据集\mosei\raw\audio\full</strong>目录下的whisper_rec.py获取所需要得到time_stamps的音频文件（修改音频路径，存储路径）</p></li> <li><p>接着运行服务器上目录为**/autodl-tmp/alpaca-lora/ljh/code/**下的sim2.py文件，获取得到对齐结果，存储在pkl文件中（修改存储路径）</p></li> <li><p>接着本地对视频（<strong>d\数据集\mosei\load.py</strong>）、音频进行clip（<strong>d\数据集\mosei\clip-audio.py</strong>）（修改存储路径）</p></li></ol> <h3 id="自训练"><a href="#自训练" class="header-anchor">#</a> 自训练</h3> <p>基于预训练模型，跑一遍推理；输出csv文件，每类选取top_k个样本（confidence），扩充训练集，重新训练模型，冻结regression头，重新训练p次</p> <p>首先进行预训练，通过修改模型参数保存路径，保存到指定路径下</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">bash</span> train.sh <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> ./trainlog_mosei/mylog.log
</code></pre></div><p>从指定路径下加载模型参数，运行以下指令，会读取/root/autodl-tmp/alpaca-lora/ljh/DPC_KNN/data/ami/ami_audiofilter.csv文件，推理ami数据集，得到伪标签，保存结果在/root/autodl-tmp/alpaca-lora/ljh/code/distill_gate/SFIN_origin/ami_result/ami_pred.csv文件中，运行目录下的analysis.py文件，会得到滤除后的top-10样本的预测，即每个类别选取10个高置信度的样本，最终得到filter_ami_pred.csv文件（以追加的形式），基于该文件重新训练模型，指令的运行顺序如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">bash</span> train.sh <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> ./trainlog_mosei/mylog.log <span class="token comment"># 模型参数保存路径指定，每次重新训练路径最好保持不一致</span>
python inf_ami_args.py <span class="token comment"># 输入ami_audiofilter.csv，模型参数；输出：ami_pred.csv</span>
python analysis.py <span class="token comment"># 输入：ami_pred.csv 追加的形式输出：filter_ami_pred.csv，同时更新ami_auidofilter.csv,即剩余的未推理的ami样本</span>
<span class="token function">bash</span> train.sh <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> ./trainlog_mosei/mylog.log <span class="token comment"># 输入：filter_ami_pred.csv，模型参数保存路径指定，指定为retrain模式</span>
python inf_ami_args.py <span class="token comment"># 输入ami_audiofilter.csv，模型参数；输出：ami_pred.csv</span>
python analysis.py <span class="token comment"># 输入：ami_pred.csv 追加的形式输出：filter_ami_pred.csv，同时更新ami_auidofilter.csv,即剩余的未推理的ami样本</span>
</code></pre></div><p>现在retrain的想法是，val head损失由mosei数据集提供，emo head的损失由mosei+ami数据集提供。</p> <p>已封装成相关指令，循环自训练的指令</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">bash</span> train.sh <span class="token parameter variable">--nothing</span> <span class="token parameter variable">--dataset</span> mosei <span class="token parameter variable">--fusion_mode</span> inter_intra <span class="token parameter variable">--retrain</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> ./trainlog_mosei/mylog.log
</code></pre></div><p>每次重新自训练前，需要更新初始模型，路径在<u><strong>model_single/mosei/inter_intramodelf1.pt</strong></u>中，需更换为初始模型，路径在<u><strong>model_single_originvideo/mosei/inter_intramodelf.pt</strong></u>，更换**<u>ami_audiofilter.csv</u><strong>为初始版本，删除</strong><u>ami_result/ami_pred.csv</u><strong>，</strong><u>ami_result/filter_ami_pred.csv</u>**</p> <h3 id="画图"><a href="#画图" class="header-anchor">#</a> 画图</h3> <p>让坐标轴的label始终对准每一小格的中间，思路：首先得到每一个grid的size，然后获取坐标的起止，让每个刻度都加grid_size/2，终止刻度也要加0.5，传入即可</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment"># 获取横坐标轴的范围</span>
x_min<span class="token punctuation">,</span> x_max <span class="token operator">=</span> plt<span class="token punctuation">.</span>xlim<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># -0.5 0.5 1.5 2.5 3.5 4.5 5.5 6.5 7.5 8.5 9.5 10.5 11.5 12.5 13.5</span>
<span class="token comment"># 计算一个小格的长度</span>
grid_size <span class="token operator">=</span> <span class="token punctuation">(</span>x_max <span class="token operator">-</span> x_min<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>words<span class="token punctuation">)</span> <span class="token comment">#word为每一小格放置的label</span>
ticks <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>x_min <span class="token operator">+</span> grid_size<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> x_max <span class="token operator">+</span> grid_size<span class="token operator">/</span><span class="token number">2</span> <span class="token punctuation">,</span> grid_size<span class="token punctuation">)</span>
</code></pre></div><p><img src="/myblog/assets/img/image_1.75619ac2.png" alt="image-20240325160500471"></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/myblog/tec/typora/grammar.html" class="prev">
        typora
      </a></span> <span class="next"><a href="/myblog/exp/idea.html">
        想法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/myblog/assets/js/app.f3a8c44d.js" defer></script><script src="/myblog/assets/js/2.deb0a2cd.js" defer></script><script src="/myblog/assets/js/1.1c52931d.js" defer></script><script src="/myblog/assets/js/25.d83bf4c1.js" defer></script>
  </body>
</html>
